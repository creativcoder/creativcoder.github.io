{"componentChunkName":"component---src-templates-page-js","path":"/service-workers-servo","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Basic Service Worker support lands in Servo","date":"29 June 2016","path":"/service-workers-servo","author":"creativcoder","excerpt":"An Implementation overview","tags":["servo","rust","open-source","gsoc"],"coverImage":null},"id":"cb0c6f75-42f8-5525-9877-08071371a232","html":"<p>The last few weeks were exciting! With amazing guidance from <a href=\"https://github.com/jdm\">Josh</a> and awesome people at <a href=\"https://github.com/servo/servo\">Servo</a> I finally have a rudimentary implementation of <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API\">Service Workers</a> (hereby mentioned as SW) in Servo capable enough to monitor network requests made from different origins and optionally send back custom responses on a registered origin with basic lifecyle events (<code class=\"language-text\">statechange</code>, <code class=\"language-text\">activate</code>, <code class=\"language-text\">install</code>) supported.</p>\n<p>Currently Service Workers are gated behind a <code class=\"language-text\">dom.serviceworker.enabled</code> flag in Servo. To make them available in DOM's <code class=\"language-text\">window.navigator</code> object, Servo needs to be launched with:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">./mach run --release http://example.com --pref dom.serviceworker.enabled<span class=\"token operator\">=</span>true</code></pre></div>\n<p>An example test page specific to Servo's implementation is available under <a href=\"https://github.com/servo/servo/tree/master/tests/html/service-worker\">html/service-workers</a>. This page can be used to test the current implementation.</p>\n<p>This post will give an overview of the current implementation of SWs in Servo. Please note that the codebase is likely to change in future due to dependency over multitude of features such as the Fetch API (<a href=\"https://github.com/servo/servo/issues/11894\">Tracking Issue</a>) whose implementation is in progress and the Promise API (<a href=\"https://github.com/servo/servo/issues/4282\">Tracking Issue</a>). I also maintain a <a href=\"http://github.com/creativcoder/gsoc16\">repo</a> keeping track of SW implementation in Servo.</p>\n<p>To get a basic idea of what Service Workers are, refer to my <a href=\"/service-workers-web/\">previous</a> blog post. Before we talk about SWs implementation, it's helpful to mention some of the key concepts in Servo's architecture.</p>\n<p>I will mention only the topics that are important to SWs implementation. To get a broad overview of Servo's architecture; refer to the <a href=\"https://github.com/servo/servo/wiki/Design\">Servo Wiki</a> or my <a href=\"/community-bonding-gsoc-servo\">blog post</a>.</p>\n<h2>Constellation</h2>\n<p>A Constellation in Servo is a co-ordinator of various pipelines along with other entities such as the windowing system, resource manager, caching system etc.</p>\n<h2>Pipeline</h2>\n<p>A Pipeline in Servo is an abstraction of a Script Thread, Layout Thread and a Paint Thread (basically a page which gets parsed and rendered to a viewport).</p>\n<p>We'll only focus on Script Thread here.</p>\n<p>The Script Thread is holds the DOM for a web document and is responsible for handling execution of javascript on the page.</p>\n<p>Service workers are designed so as not to depend on any context/document so they must be at a higher level in the abstraction hierarchy than the Script Thread. They can listen to network requests globally. As such, a service worker manager thread (hereby mentioned as SWM) was devised to manage service worker registrations at different origins. The idea is to have a single manager thread that can store information of all registered SW's and can listen to network requests, activation or timeouts of any of the SW's.</p>\n<p>The following interfaces of the Service Workers API are available in Servo (without promise integration):</p>\n<h2>Client Context:</h2>\n<p><a href=\"https://github.com/servo/servo/blob/master/components/script/dom/serviceworker.rs\">ServiceWorker</a></p>\n<p><a href=\"https://github.com/servo/servo/blob/master/components/script/dom/serviceworkercontainer.rs\">ServiceWorkerContainer</a></p>\n<p><a href=\"https://github.com/servo/servo/blob/master/components/script/dom/serviceworkerregistration.rs\">ServiceWorkerRegistration</a></p>\n<h2>Execution Context:</h2>\n<p><a href=\"https://github.com/servo/servo/blob/master/components/script/dom/serviceworkerglobalscope.rs\">ServiceWorkerGlobalScope</a></p>\n<ul>\n<li>The initialization phase: </li>\n</ul>\n<p><img src=\"http://i.imgur.com/rAv1za8.jpg\" alt=\"alt init_phase\"></p>\n<p>The Constellation thread is created before any of the above mentioned threads. So it creates the required channels (here channel means creating a (Sender<T> Receiver<T>) pair for inter-thread communication) for SWM and passes the SWM's sender when the constellation creates the script thread which spawns the SWM thread. We also create a channel for the resource thread to communicate with constellation. This is needed so that the resource thread can ask for any custom response from SWM mediated by constellation.</p>\n<ul>\n<li>The registration phase:</li>\n</ul>\n<p><img src=\"http://i.imgur.com/lWJVImJ.jpg\" alt=\"alt reg_phase\"></p>\n<p>Let's take an example of a URL <code class=\"language-text\">https://example.com</code> where we register a SW over the scope: <code class=\"language-text\">/profile</code>. We can register a Service Worker by calling </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">navigator<span class=\"token punctuation\">.</span>serviceWorker<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sw.js'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> scope<span class=\"token operator\">:</span> <span class=\"token string\">'/profile'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>which returns a registration object. This registration object is then stored in the ScriptThread's thread local storage. At this point, the worker does not start controlling pages or listening to events; instead it forwards the attributes required to spawn service to the SWM which handles the initialization of <code class=\"language-text\">ServiceWorkerGlobalScope</code> upon url navigations.</p>\n<ul>\n<li>The network phase:</li>\n</ul>\n<p><img src=\"http://i.imgur.com/xH9HrTR.jpg\" alt=\"alt net_phase\"></p>\n<p>When the browser is navigated to the URL <code class=\"language-text\">https://example.com/profile</code> where the SW was registered, the <code class=\"language-text\">http_loader</code> sends a <code class=\"language-text\">Sender</code> channel to the SWM and asks whether the currently loaded URL has a running service worker that may have a custom response. Here the SWM forwards the network's sender to the running <code class=\"language-text\">ServiceWorkerGlobalScope</code>'s event loop which then able to reply with any custom response that is cached in.</p>\n<p>PS : This is still a WIP post, and there will be additions.</p>","excerpt":"The last few weeks were exciting! With amazing guidance from Josh and awesome people at Servo I finally have a rudimentary implementation ofâ€¦"}},"pageContext":{"type":"posts","next":{"frontmatter":{"path":"/typeclasses-in-haskell","title":"A short intro to type classes in Haskell","tags":["haskell","functional programming","type theory","lambda calculus"]},"fileAbsolutePath":"/home/rahul/opensource/creativcoder.dev/src/posts/typeclasses-in-haskell.md"},"previous":{"frontmatter":{"path":"/dynamic-programming-primer","title":"Dynamic programming primer","tags":["algorithms","optimization","beginner","dynamic-programming"]},"fileAbsolutePath":"/home/rahul/opensource/creativcoder.dev/src/posts/dynamic-programming-primer.md"}}}}